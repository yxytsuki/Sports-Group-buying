'use strict';

var axios = require('axios');
var I = require('axios/unsafe/helpers/buildURL');
var N = require('axios/unsafe/helpers/speedometer');
var P = require('axios/unsafe/core/buildFullPath');
var W = require('axios/unsafe/core/settle');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var I__default = /*#__PURE__*/_interopDefault(I);
var N__default = /*#__PURE__*/_interopDefault(N);
var P__default = /*#__PURE__*/_interopDefault(P);
var W__default = /*#__PURE__*/_interopDefault(W);

var g=e=>{let{method:i="GET"}=e;switch(i.toLocaleLowerCase()){case"download":return "download";case"upload":return "upload";default:return "request"}},T=e=>({...e}),c=(e,i)=>{var A,w;let d=e.data,s=e.responseType==="arraybuffer"?"arraybuffer":"text",a=s==="text"?"json":void 0,{headers:n,baseURL:u,...t}=e,o=axios.AxiosHeaders.from(n).normalize(!1);if(e.auth){let C=e.auth.username||"",H=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";o.set("Authorization","Basic "+btoa(C+":"+H));}let r=P__default.default(u,e.url),p=(w=(A=e==null?void 0:e.method)==null?void 0:A.toUpperCase())!=null?w:"GET",l=I__default.default(r,e.params,e.paramsSerializer),U=e.timeout||6e4,x={};if(d&&typeof d=="string")try{x=JSON.parse(d);}catch(C){}let k=o.toJSON();return {...t,url:l,data:d,header:k,method:p,responseType:s,dataType:a,timeout:U,formData:x}},q=(e,i)=>{let d=0,s=N__default.default(50,250);return a=>{let n=a.totalBytesWritten,u=a.totalBytesExpectedToWrite,t=n-d,o=s(t),r=n<=u;d=n;let p={loaded:n,total:u,progress:u?n/u:void 0,bytes:t,rate:o||void 0,estimated:o&&u&&r?(u-n)/o:void 0,event:a};p[i?"download":"upload"]=!0,e(p);}};var f=class{constructor(i){this.config=i;}subscribe(i,d){(this.config.cancelToken||this.config.signal)&&(this.onCanceled=s=>{i&&(d(!s||s.type?new axios.CanceledError(void 0,void 0,this.config,i):s),i.abort(),i=null);},this.config.cancelToken&&this.config.cancelToken.subscribe(this.onCanceled),this.config.signal&&this.config.signal.addEventListener&&(this.config.signal.aborted?this.onCanceled():this.config.signal.addEventListener("abort",this.onCanceled)));}unsubscribe(){this.config.cancelToken&&this.config.cancelToken.unsubscribe(this.onCanceled),this.config.signal&&this.config.signal.removeEventListener&&this.config.signal.removeEventListener("abort",this.onCanceled);}};var K=(e,i)=>new Promise((d,s)=>{let a=c(e),n=e;n.headers=new axios.AxiosHeaders(a.header);let u=new f(e),t=uni.downloadFile({...a,success(o){var p;if(!t)return;let r={config:n,data:o.tempFilePath,headers:{},status:o.statusCode,statusText:(p=o.errMsg)!=null?p:"OK",request:t};W__default.default(d,s,r),t=null;},fail(o){let{errMsg:r=""}=o!=null?o:{};r&&(r==="downloadFile:fail timeout"&&s(new axios.AxiosError(r,axios.AxiosError.ETIMEDOUT,n,t)),r==="downloadFile:fail"&&s(new axios.AxiosError(r,axios.AxiosError.ERR_NETWORK,n,t))),s(new axios.AxiosError(o.errMsg,void 0,n,t)),t=null;},complete(){u.unsubscribe();}});typeof e.onDownloadProgress=="function"&&t.onProgressUpdate(q(e.onDownloadProgress,!0)),typeof e.onHeadersReceived=="function"&&t.onHeadersReceived(e.onHeadersReceived),u.subscribe(t,s);}),b=K;var z=(e,i)=>new Promise((d,s)=>{let a=c(e),n=e;n.headers=new axios.AxiosHeaders(a.header);let u=new f(e),t=uni.uploadFile({...a,success(o){var p;if(!t)return;let r={config:n,data:o.data,headers:{},status:o.statusCode,statusText:(p=o.errMsg)!=null?p:"OK",request:t};W__default.default(d,s,r),t=null;},fail(o){let{errMsg:r=""}=o!=null?o:{};if(r){let p=r==="uploadFile:fail timeout",l=r==="uploadFile:fail file error";p&&s(new axios.AxiosError(r,axios.AxiosError.ETIMEDOUT,n,t)),l&&s(new axios.AxiosError(r,axios.AxiosError.ERR_NETWORK,n,t));}s(new axios.AxiosError(o.errMsg,void 0,n,t)),t=null;},complete(){u.unsubscribe();}});typeof e.onHeadersReceived=="function"&&t.onHeadersReceived(e.onHeadersReceived),u.subscribe(t,s);}),y=z;var G=(e,i)=>new Promise((d,s)=>{let a=c(e),n=e;n.headers=new axios.AxiosHeaders(a.header);let u=new f(e),t=uni.request({...a,success(o){var l;if(!t)return;let r=new axios.AxiosHeaders(o.header),p={config:n,data:o.data,headers:r,status:o.statusCode,statusText:(l=o.errMsg)!=null?l:"OK",request:t,cookies:o.cookies};W__default.default(d,s,p),t=null;},fail(o){let{errMsg:r=""}=o!=null?o:{};if(r){let p=r==="request:fail timeout",l=r==="request:fail";p&&s(new axios.AxiosError(r,axios.AxiosError.ETIMEDOUT,n,t)),l&&s(new axios.AxiosError(r,axios.AxiosError.ERR_NETWORK,n,t));}s(new axios.AxiosError(o.errMsg,void 0,n,t)),t=null;},complete(){u.unsubscribe();}});typeof e.onHeadersReceived=="function"&&t.onHeadersReceived(e.onHeadersReceived),u.subscribe(t,s);}),O=G;var v=e=>{switch(g(e)){case"download":return b;case"upload":return y;default:return O}};var Pe=(e={})=>{let i=T(e);return axios.Axios.prototype.download=function(s,a){return this.request({url:s,method:"download",...a})},axios.Axios.prototype.upload=function(s,a,n){return this.request({url:s,method:"upload",data:a,...n})},s=>v(s)(s,i)};

exports.createUniAppAxiosAdapter = Pe;
