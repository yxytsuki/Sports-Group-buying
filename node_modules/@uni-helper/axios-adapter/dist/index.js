import { Axios, AxiosHeaders, AxiosError, CanceledError } from 'axios';
import I from 'axios/unsafe/helpers/buildURL';
import N from 'axios/unsafe/helpers/speedometer';
import P from 'axios/unsafe/core/buildFullPath';
import W from 'axios/unsafe/core/settle';

var g=e=>{let{method:i="GET"}=e;switch(i.toLocaleLowerCase()){case"download":return "download";case"upload":return "upload";default:return "request"}},T=e=>({...e}),c=(e,i)=>{var A,w;let d=e.data,s=e.responseType==="arraybuffer"?"arraybuffer":"text",a=s==="text"?"json":void 0,{headers:n,baseURL:u,...t}=e,o=AxiosHeaders.from(n).normalize(!1);if(e.auth){let C=e.auth.username||"",H=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";o.set("Authorization","Basic "+btoa(C+":"+H));}let r=P(u,e.url),p=(w=(A=e==null?void 0:e.method)==null?void 0:A.toUpperCase())!=null?w:"GET",l=I(r,e.params,e.paramsSerializer),U=e.timeout||6e4,x={};if(d&&typeof d=="string")try{x=JSON.parse(d);}catch(C){}let k=o.toJSON();return {...t,url:l,data:d,header:k,method:p,responseType:s,dataType:a,timeout:U,formData:x}},q=(e,i)=>{let d=0,s=N(50,250);return a=>{let n=a.totalBytesWritten,u=a.totalBytesExpectedToWrite,t=n-d,o=s(t),r=n<=u;d=n;let p={loaded:n,total:u,progress:u?n/u:void 0,bytes:t,rate:o||void 0,estimated:o&&u&&r?(u-n)/o:void 0,event:a};p[i?"download":"upload"]=!0,e(p);}};var f=class{constructor(i){this.config=i;}subscribe(i,d){(this.config.cancelToken||this.config.signal)&&(this.onCanceled=s=>{i&&(d(!s||s.type?new CanceledError(void 0,void 0,this.config,i):s),i.abort(),i=null);},this.config.cancelToken&&this.config.cancelToken.subscribe(this.onCanceled),this.config.signal&&this.config.signal.addEventListener&&(this.config.signal.aborted?this.onCanceled():this.config.signal.addEventListener("abort",this.onCanceled)));}unsubscribe(){this.config.cancelToken&&this.config.cancelToken.unsubscribe(this.onCanceled),this.config.signal&&this.config.signal.removeEventListener&&this.config.signal.removeEventListener("abort",this.onCanceled);}};var K=(e,i)=>new Promise((d,s)=>{let a=c(e),n=e;n.headers=new AxiosHeaders(a.header);let u=new f(e),t=uni.downloadFile({...a,success(o){var p;if(!t)return;let r={config:n,data:o.tempFilePath,headers:{},status:o.statusCode,statusText:(p=o.errMsg)!=null?p:"OK",request:t};W(d,s,r),t=null;},fail(o){let{errMsg:r=""}=o!=null?o:{};r&&(r==="downloadFile:fail timeout"&&s(new AxiosError(r,AxiosError.ETIMEDOUT,n,t)),r==="downloadFile:fail"&&s(new AxiosError(r,AxiosError.ERR_NETWORK,n,t))),s(new AxiosError(o.errMsg,void 0,n,t)),t=null;},complete(){u.unsubscribe();}});typeof e.onDownloadProgress=="function"&&t.onProgressUpdate(q(e.onDownloadProgress,!0)),typeof e.onHeadersReceived=="function"&&t.onHeadersReceived(e.onHeadersReceived),u.subscribe(t,s);}),b=K;var z=(e,i)=>new Promise((d,s)=>{let a=c(e),n=e;n.headers=new AxiosHeaders(a.header);let u=new f(e),t=uni.uploadFile({...a,success(o){var p;if(!t)return;let r={config:n,data:o.data,headers:{},status:o.statusCode,statusText:(p=o.errMsg)!=null?p:"OK",request:t};W(d,s,r),t=null;},fail(o){let{errMsg:r=""}=o!=null?o:{};if(r){let p=r==="uploadFile:fail timeout",l=r==="uploadFile:fail file error";p&&s(new AxiosError(r,AxiosError.ETIMEDOUT,n,t)),l&&s(new AxiosError(r,AxiosError.ERR_NETWORK,n,t));}s(new AxiosError(o.errMsg,void 0,n,t)),t=null;},complete(){u.unsubscribe();}});typeof e.onHeadersReceived=="function"&&t.onHeadersReceived(e.onHeadersReceived),u.subscribe(t,s);}),y=z;var G=(e,i)=>new Promise((d,s)=>{let a=c(e),n=e;n.headers=new AxiosHeaders(a.header);let u=new f(e),t=uni.request({...a,success(o){var l;if(!t)return;let r=new AxiosHeaders(o.header),p={config:n,data:o.data,headers:r,status:o.statusCode,statusText:(l=o.errMsg)!=null?l:"OK",request:t,cookies:o.cookies};W(d,s,p),t=null;},fail(o){let{errMsg:r=""}=o!=null?o:{};if(r){let p=r==="request:fail timeout",l=r==="request:fail";p&&s(new AxiosError(r,AxiosError.ETIMEDOUT,n,t)),l&&s(new AxiosError(r,AxiosError.ERR_NETWORK,n,t));}s(new AxiosError(o.errMsg,void 0,n,t)),t=null;},complete(){u.unsubscribe();}});typeof e.onHeadersReceived=="function"&&t.onHeadersReceived(e.onHeadersReceived),u.subscribe(t,s);}),O=G;var v=e=>{switch(g(e)){case"download":return b;case"upload":return y;default:return O}};var Pe=(e={})=>{let i=T(e);return Axios.prototype.download=function(s,a){return this.request({url:s,method:"download",...a})},Axios.prototype.upload=function(s,a,n){return this.request({url:s,method:"upload",data:a,...n})},s=>v(s)(s,i)};

export { Pe as createUniAppAxiosAdapter };
