{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["import {\r\n\tuseUserStore\r\n} from \"../store/user\";\r\n\r\nfunction createRequest(config = {}) {\r\n\tconst defaultConfig = {\r\n\t\tbaseUrl: 'http://192.168.43.38:3000',\r\n\t\theader: {\r\n\t\t\t'content-type': 'application/json'\r\n\t\t},\r\n\t\tdataType: 'json',\r\n\t\ttoken: true\r\n\t};\r\n\t// 请求拦截器：加上 token\r\n\tfunction requestInterceptor(options) {\r\n\t\tconst token = useUserStore().userInfo.token || '';\r\n\t\tif (options.token && token) {\r\n\t\t\toptions.header = {\r\n\t\t\t\t...options.header,\r\n\t\t\t\tAuthorization: `Bearer ${token}`\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn options;\r\n\t}\r\n\r\n\t// 响应拦截器：处理状态码\r\n\tfunction responseInterceptor(response) {\r\n\t\tif (response.statusCode !== 200) {\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: response.data.desc || `网络错误(${response.statusCode})`,\r\n\t\t\t\ticon: 'none'\r\n\t\t\t});\r\n\t\t\treturn Promise.reject(response);\r\n\t\t}\r\n\r\n\t\tconst resData = response.data;\r\n\r\n\t\tif (resData.status !== 200) {\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: resData.desc || '请求失败',\r\n\t\t\t\ticon: 'none'\r\n\t\t\t});\r\n\t\t\treturn Promise.reject(resData);\r\n\t\t}\r\n\r\n\t\treturn resData.data;\r\n\t}\r\n\r\n\t// 通用请求函数\r\n\tfunction baseRequest(method, url, data = {}, options = {}) {\r\n\t\t// 处理 GET 参数拼接\r\n\t\tif (method === 'GET' && options.params) {\r\n\t\t\tconst queryString = Object.keys(options.params)\r\n\t\t\t\t.map(key => `${encodeURIComponent(key)}=${encodeURIComponent(options.params[key])}`)\r\n\t\t\t\t.join('&');\r\n\t\t\tif (queryString) {\r\n\t\t\t\turl += (url.includes('?') ? '&' : '?') + queryString;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst finalOptions = {\r\n\t\t\t...defaultConfig,\r\n\t\t\t...config,\r\n\t\t\t...options,\r\n\t\t\turl: (config.baseUrl || defaultConfig.baseUrl) + url,\r\n\t\t\tdata,\r\n\t\t\tmethod,\r\n\t\t\theader: {\r\n\t\t\t\t...defaultConfig.header,\r\n\t\t\t\t...(config.header || {}),\r\n\t\t\t\t...(options.header || {})\r\n\t\t\t},\r\n\t\t\ttoken: options.token !== undefined ? options.token : defaultConfig.token\r\n\t\t};\r\n\r\n\t\tconst interceptedOptions = requestInterceptor(finalOptions);\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tuni.showLoading({\r\n\t\t\t\ttitle: '加载中',\r\n\t\t\t\tmask: true\r\n\t\t\t});\r\n\r\n\t\t\tuni.request({\r\n\t\t\t\t...interceptedOptions,\r\n\t\t\t\tsuccess: (result) => {\r\n\t\t\t\t\tuni.hideLoading();\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst data = responseInterceptor(result);\r\n\t\t\t\t\t\tresolve(data);\r\n\t\t\t\t\t} catch (err) {\r\n\t\t\t\t\t\treject(err);\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ttitle: err.desc || '出错啦',\r\n\t\t\t\t\t\t\ticon: \"fail\",\r\n\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\tfail: (err) => {\r\n\t\t\t\t\tuni.hideLoading();\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: '网络开小差啦~',\r\n\t\t\t\t\t\ticon: 'error'\r\n\t\t\t\t\t});\r\n\t\t\t\t\treject(err);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t// 暴露统一接口\r\n\treturn {\r\n\t\tget: (url, options = {}) => baseRequest('GET', url, {}, options),\r\n\t\tpost: (url, data = {}, options = {}) => baseRequest('POST', url, data, options),\r\n\t\tput: (url, data = {}, options = {}) => baseRequest('PUT', url, data, options),\r\n\t\tdelete: (url, data = {}, options = {}) => baseRequest('DELETE', url, data, options)\r\n\t};\r\n}\r\n\r\nconst request = createRequest();\r\nexport default request;"],"names":["useUserStore","uni","data"],"mappings":"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"}